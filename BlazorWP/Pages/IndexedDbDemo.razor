@page "/indexeddb-demo"
@using TG.Blazor.IndexedDB
<PageTitle>IndexedDB Demo</PageTitle>

<h3>IndexedDB Demo â€“ Notes</h3>

<!-- Note entry form (for adding or editing) -->
<div class="mb-3">
    <label class="form-label"><strong>Name:</strong></label>
    <input @bind="currentNote.Name" class="form-control" placeholder="Enter note name" />
</div>
<div class="mb-3">
    <label class="form-label"><strong>Description:</strong></label>
    <textarea @bind="currentNote.Description" class="form-control" placeholder="Enter description"></textarea>
</div>
<button class="btn btn-primary me-2" @onclick="SaveNote">
    @if (isEditing) { <span>Update Note</span> } else { <span>Add Note</span> }
</button>
@if (isEditing)
{
    <button class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
}

<hr />

<!-- Notes list display -->
@if (notes.Count == 0)
{
    <p><em>No notes available.</em></p>
}
else
{
    <table class="table align-middle">
        <thead>
            <tr>
                <th>Name</th>
                <th>Description</th>
                <th style="width:150px;">Actions</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var note in notes)
        {
            <tr>
                <td>@note.Name</td>
                <td>@note.Description</td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary me-1" @onclick="@(() => EditNote(note))">Edit</button>
                    <button class="btn btn-sm btn-danger" @onclick="@(() => DeleteNote(note))">Delete</button>
                </td>
            </tr>
        }
        </tbody>
    </table>
}

@code {
    private IndexedDBManager? dbManager;
    [Inject] private IIndexedDbFactory DbFactory { get; set; } = default!;

    private List<Note> notes = new();
    private Note currentNote = new Note();  // holds data for the form (new or editing)
    private bool isEditing = false;         // flag to indicate if we are editing an existing note

    protected override async Task OnInitializedAsync()
    {
        dbManager = await DbFactory.Create("BlazorWPDB");
        // Load all existing notes from IndexedDB on page load
        await LoadNotesAsync();
    }

    // Fetch all notes from the "notes" object store
    private async Task LoadNotesAsync()
    {
        notes = await dbManager!.GetRecords<Note>("notes") ?? new List<Note>();
    }

    // Add a new note or update an existing one
    private async Task SaveNote()
    {
        if (!isEditing)
        {
            currentNote.Id = Guid.NewGuid().ToString();
            await dbManager!.AddRecord(new StoreRecord<Note>
            {
                StoreName = "notes",
                Record = currentNote
            });
        }
        else
        {
            await dbManager!.UpdateRecord(new StoreRecord<Note>
            {
                StoreName = "notes",
                Record = currentNote
            });
        }

        await LoadNotesAsync();                  // Refresh the notes list from the database
        currentNote = new Note();                // Reset form to a new blank note
        isEditing = false;
    }

    // Begin editing an existing note (populate the form with its data)
    private void EditNote(Note note)
    {
        // Clone the selected note into currentNote (to avoid directly editing the list item until saved)
        currentNote = new Note 
        { 
            Id = note.Id, 
            Name = note.Name, 
            Description = note.Description 
        };
        isEditing = true;
    }

    // Delete a note from the database
    private async Task DeleteNote(Note note)
    {
        await dbManager!.DeleteRecord("notes", note.Id);
        await LoadNotesAsync();             // Refresh the list to reflect deletion
    }

    // Cancel edit mode and clear the form
    private void CancelEdit()
    {
        currentNote = new Note();
        isEditing = false;
    }

    // Note model
    private class Note
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
    }
}

